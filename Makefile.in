CC?=@CC@

PY_LDFLAGS+=@PYTHON_LDFLAGS@
PY_CFLAGS+=@PYTHON_CFLAGS@

SQL_CFLAGS=@SQLITE_CFLAGS@
SQL_LDFLAGS=@SQLITE_LIBS@

SSL_CFLAGS=@SSL_CFLAGS@
SSL_LDFLAGS=@SSL_LIBS@

CONFIG_CFLAGS=@LIBCONFIG_CFLAGS@
CONFIG_LDFLAGS=@LIBCONFIG_LIBS@

BSD_CFLAGS=@BSD_CFLAGS@
BSD_LDFLAGS=@BSD_LIBS@

TAG_CFLAGS=@TAGLIB_CFLAGS@
TAG_LDFLAGS=@TAGLIB_LIBS@

CFLAGS+=@CFLAGS@ -Wall -Wextra -g
LDFLAGS+=@LIBS@
CPPFLAGS+=@CPPFLAGS@

INSTALL?=install
PACKAGE_TARNAME=@PACKAGE_TARNAME@

# GNU standard paths
prefix?=@prefix@
exec_prefix=@exec_prefix@
mandir?=@mandir@
sbindir?=@sbindir@
bindir?=@bindir@
datarootdir?=@datarootdir@
docdir?=@docdir@

# convenience paths for us
pydocdir=${docdir}/pydoc
sampledir?=${datarootdir}/examples/hgd
pysupportdir=${datarootdir}/hgd/pylib/hgd

.PHONY: all
all: hgd-playd hgd-netd hgd-admin hgdc hgd-mk-pydoc

.PHONY: clean
clean:
	rm -f hgd-playd hgd-netd hgdc common.o db.o py.o crypto.o net.o cfg.o

.PHONY: analyze
analyze:
	@echo "****** THIS NEEDS CLANG *******"
	${CC} --analyze ${SSL_CFLAGS} ${CPPFLAGS} ${CFLAGS} crypto.c
	${CC} --analyze ${SSL_CFLAGS} ${CPPFLAGS} ${CFLAGS} net.c
	${CC} --analyze ${SQL_CFLAGS} ${PY_CFLAGS} ${CPPFLAGS} ${CFLAGS} py.c
	${CC} --analyze ${CPPFLAGS} ${CFLAGS} ${SSL_CFLAGS} common.c
	${CC} --analyze ${CPPFLAGS} ${SQL_CFLAGS} ${CFLAGS} db.c
	${CC} --analyze ${CPPFLAGS} ${SQL_CFLAGS} ${PY_CFLAGS} ${CFLAGS} \
		hgd-playd.c
	${CC} --analyze ${TAG_CFLAGS} ${TAG_LDFLAGS} ${CPPFLAGS} ${SQL_CFLAGS} \
		hgd-netd.c
	${CC} --analyze ${CPPFLAGS} ${CONFIG_CFLAGS} ${CFLAGS} \
		${CONFIG_LDFLAGS}  \
		hgdc.c
	${CC} --analyze ${CPPFLAGS} ${CFLAGS} ${CONFIG_CFLAGS} ${SQL_CPPFLAGS} \
		hgd-admin.c
	${CC} --analyze ${CPPFLAGS} ${CFLAGS} ${PY_CFLAGS}  \
		${SSL_CFLAGS} ${SQLITE_CFLAGS} \
		${BSD_CFLAGS} hgd-mk-pydoc
	


cfg.o: cfg.h cfg.c
	${CC} ${CPPFLAGS} ${CFLAGS} ${CONFIG_LDFLAGS} -c -o cfg.o cfg.c

crypto.o: crypto.h crypto.c hgd.h config.h
	${CC} ${SSL_CFLAGS} ${CPPFLAGS} ${CFLAGS} -c -o crypto.o crypto.c

net.o: net.h net.c hgd.h config.h
	${CC} ${SSL_CFLAGS} ${CPPFLAGS} ${CFLAGS} -c -o net.o net.c

py.o: py.c py.h config.h
	${CC} ${SQL_CFLAGS} ${PY_CFLAGS} ${CPPFLAGS} ${CFLAGS} -c -o py.o py.c

common.o: common.c hgd.h config.h
	${CC} ${CPPFLAGS} ${CFLAGS} ${SSL_CFLAGS} -c -o common.o common.c

db.o: db.c hgd.h config.h db.h
	${CC} ${CPPFLAGS} ${SQL_CFLAGS} ${CFLAGS} -c -o db.o db.c

mplayer.o: mplayer.c mplayer.h py.o
	${CC} ${SQL_CFLAGS} ${PY_CFLAGS} ${CPPFLAGS} ${CFLAGS} -c -o mplayer.o py.o mplayer.c

hgd-playd: common.o db.o py.o hgd-playd.c hgd.h config.h crypto.o mplayer.o cfg.o
	${CC} ${CPPFLAGS} ${SQL_CFLAGS} ${PY_CFLAGS} ${CFLAGS} ${SQL_LDFLAGS} \
		${SSL_LDFLAGS} ${LDFLAGS} ${PY_LDFLAGS} ${BSD_LDFLAGS} \
		${CONFIG_LDFLAGS} \
		-o hgd-playd db.o common.o crypto.o py.o mplayer.o cfg.o hgd-playd.c

hgd-netd: cfg.o common.o net.o hgd-netd.c hgd.h db.o cfg.o crypto.o
	${CC} ${TAG_CFLAGS} ${TAG_LDFLAGS} ${CPPFLAGS} ${SQL_CFLAGS} \
		${CFLAGS} ${SQL_LDFLAGS} ${SSL_LDFLAGS} ${LDFLAGS} \
		${BSD_LDFLAGS} ${CONFIG_LDFLAGS} \
		-o hgd-netd cfg.o common.o db.o net.o crypto.o hgd-netd.c

hgdc: common.o net.o cfg.o hgdc.c hgd.h config.h
	${CC} ${CPPFLAGS} ${CONFIG_CFLAGS} ${CFLAGS} ${LDFLAGS} \
		${SSL_LDFLAGS} ${BSD_LDFLAGS} ${CONFIG_LDFLAGS}  \
		-o hgdc common.o net.o cfg.o hgdc.c

hgd-admin: common.o db.o hgd.h hgd-admin.c config.h net.o crypto.o mplayer.o py.o
	${CC} ${CPPFLAGS} ${CFLAGS} ${CONFIG_CFLAGS} ${SQL_CPPFLAGS} \
		${SQL_LDFLAGS} ${SSL_LDFLAGS} ${LDFLAGS} ${BSD_LDFLAGS} \
		${CONFIG_LDFLAGS} ${PY_LDFLAGS} -o hgd-admin common.o net.o crypto.o \
		db.o mplayer.o py.o hgd-admin.c

hgd-mk-pydoc: hgd-mk-pydoc.c config.h hgd.h py.o common.o db.o crypto.o
	${CC} ${CPPFLAGS} ${CFLAGS} ${PY_CFLAGS} ${PY_LDFLAGS} \
		${LDFLAGS} ${SSL_LDFLAGS} ${SSL_CFLAGS} ${SQLITE_CFLAGS} \
		${SQL_LDFLAGS} ${BSD_CFLAGS} ${BSD_LDFLAGS} db.o \
		common.o py.o crypto.o hgd-mk-pydoc.c -o hgd-mk-pydoc

client: hgdc
server: hgd-netd hgd-playd hgd-admin

.PHONY: install
install: install-client install-server install-doc

.PHONY: install-client
install-client: hgdc
	${INSTALL} -d ${DESTDIR}${bindir}
	${INSTALL} hgdc ${DESTDIR}${bindir}

.PHONY: install-server
install-server: hgd-netd hgd-admin hgd-playd
	${INSTALL} -d ${DESTDIR}${sbindir}
	${INSTALL} hgd-netd ${DESTDIR}${sbindir}
	${INSTALL} hgd-playd ${DESTDIR}${sbindir}
	${INSTALL} hgd-admin ${DESTDIR}${sbindir}

	${INSTALL} -d ${DESTDIR}${pysupportdir}
	${INSTALL} pylib/hgd/__init__.py ${DESTDIR}${pysupportdir}
	${INSTALL} pylib/hgd/playlist.py ${DESTDIR}${pysupportdir}
	${INSTALL} pylib/hgd/doccer.py ${DESTDIR}${pysupportdir}

.PHONY: install-doc
install-doc: install-pydoc
	${INSTALL} -d ${DESTDIR}${mandir}/man1
	${INSTALL} -d ${DESTDIR}${mandir}/man7
	${INSTALL} -d ${DESTDIR}${docdir}
	${INSTALL} -d ${DESTDIR}${sampledir}
	${INSTALL} man/hgd-netd.1 ${DESTDIR}${mandir}/man1/
	${INSTALL} man/hgd-playd.1 ${DESTDIR}${mandir}/man1/
	${INSTALL} man/hgdc.1 ${DESTDIR}${mandir}/man1/
	${INSTALL} man/hgd-admin.1 ${DESTDIR}${mandir}/man1/
	${INSTALL} man/hgd-proto.7 ${DESTDIR}${mandir}/man7/
	${INSTALL} man/hgd-scripting.7 ${DESTDIR}${mandir}/man7/
	${INSTALL} README ${DESTDIR}${docdir}
	${INSTALL} share/examples/hgd.rc ${DESTDIR}${sampledir}
	${INSTALL} share/examples/hgdc.rc ${DESTDIR}${sampledir}

.PHONY: pydoc
# XXX this makes build time references to the build dir. sigh...
pydoc: hgd-mk-pydoc
	./hgd-mk-pydoc

.PHONY: install-pydoc
install-pydoc:
	${INSTALL} -d ${DESTDIR}${pydocdir}
	${INSTALL} -d ${DESTDIR}${pydocdir}/txt
	#${INSTALL} -d ${DESTDIR}${pydocdir}/html
	${INSTALL} pydoc/txt/index.txt ${DESTDIR}${pydocdir}/txt/
	${INSTALL} pydoc/txt/hgd.playlist.txt ${DESTDIR}${pydocdir}/txt/
	${INSTALL} pydoc/txt/hgd.doccer.txt ${DESTDIR}${pydocdir}/txt/
	#${INSTALL} pydoc/html/index.html ${DESTDIR}${pydocdir}/html/
	#${INSTALL} pydoc/html/hgd.playlist.html ${DESTDIR}${pydocdir}/html/
	#${INSTALL} pydoc/html/hgd.doccer.html ${DESTDIR}${pydocdir}/html/

# OpenBSD hosts only
.PHONY: lint-mans
lint-mans:
	for i in `ls man`; do mandoc -Tlint man/$$i; done
